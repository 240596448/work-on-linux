Postgres, в отличие от MS SQL, не умеет сжатие данных.  
Зато сжатие отлично умеет zfs, файловая система и по совместительству менеджер хранилищ.
Сравнение zfs с другими фаловыми системами смотрим [здесь](https://ru.wikipedia.org/wiki/%D0%A1%D1%80%D0%B0%D0%B2%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D1%8B%D1%85_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC).  

## Предисловие
Важно! Неоптимальная конфигурация пула zfs может снизить быстродействие на порядок!  
Чтобы понять, насколько велика может быть разница, имеет смысл сделать хотя бы сферические замеры на ext4, а затем повторить их на zfs. Самый простой, хоть и не самый лучший, способ - создать раздел ext4 и выполнить dd с разным размером блока. Предположим у нас есть диск /dev/sdb, на который мы планируем положить zfs.  
Для начала форматируем его в ext4:  
```
sudo fdisk /dev/sdb
>>fdisk:
>>o
>>n
>>w
sudo mkfs.ext4 /dev/sdb1
mkdir ~/test
mount /dev/sdb1 ~/test
```
Делаем замеры:
```
cd ~/test
dd if=/dev/zero of=./largefile bs=1M count=1000
dd if=/dev/zero of=./largefile bs=10K count=100000
```
Результаты записываем и после создания тома zfs тесты повторяем. Практически все параметры томов zfs можно менять на лету: очень рекомендую попробовать поставить recordsize равным 4, 8, 16, 32, 64, 128k и сравнить результаты замеров. Так, при блоке 128k скорость записи примерно уравнивается с показателями ext4. Задрежки, конечно, при таких условиях будут ощутимо больше...  
Также можно сравнить производительность без сжатия, ну и сдругими параметрами поиграть.  
На самом деле при работе postgresql все эти замеры не будут играть такой существенной роли - запись в базу идет небольшими порциями, абсолютно хаотично и очень часто, в таких условия разница в производительности может составлять около 10%, что вполне приемлемо с учетом получаемых плюшек.  
Общие рекомендации примерно такие: если надо писать большие файлы, либо писать много потоком - ставим 128k, много мелких фалов или сильно непоследовательно - в районе 4-16k. Оптимальное значение подбираем опытным путем.  
Для СУБД особая рекомендация: имеет смысл ставить размер записи равным (или большим) размеру блока, записываемого СУБД, в случае postgresql это 8k.  


## Общие принципы

## Установка и создание пула
https://github.com/zfsonlinux/zfs/wiki/Debian
```
sudo apt install linux-headers-$(uname -r)
ln -s /bin/rm /usr/bin/rm
sudo apt install zfs-dkms zfsutils-linux
sudo modprobe zfs
sudo systemctl start zfs*
```

Создание пула для postgresql:  
```
sudo zpool create -o ashift=12 pgpool /dev/sdx -f
sudo mkdir /mnt/pgdata
sudo zfs create pgpool/pgdata -o mountpoint=/mnt/pgdata
sudo zfs set recordsize=8k pgpool/pgdata
sudo zfs set atime=off pgpool/pgdata
sudo zfs set compression=lz4 pgpool/pgdata
sudo zfs set sync=disabled pgpool/pgdata
sudo zfs primarycache=metadata pgpool/pgdata
```

```
sudo zfs get atime,compression,primarycache,recordsize pgpool/pgdata
```
"set sync=disable" требует пояснения: в данном случае данные будут попадать на диск с задержкой 5-30 сек, при этом целостность данных на уровне файловой системы гарантирована, а вот на уровне приложения есть вероятность получить рассогласования - не смертельно, но необходимо иметь в виду. В чем профит: скорость работы практически не уступает ext4. По факту это единственный вариант, при котором скорость работы zfs радует, так что или так, или ну его в пень совсем...

## Установка debian на zfs


## Ссылки
http://www.oug.org/files/presentations/zfszilsynchronicity.pdf  
http://open-zfs.org/wiki/Performance_tuning  

